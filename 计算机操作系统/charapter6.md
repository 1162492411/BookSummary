
# I/O系统的功能、模型和接口

I/O设备是计算机系统的重要资源。通常把I/O设备及其接口线路、控制部件、通道和管理软件称为`I/O系统`，把计算机的主存和外围设备的介质之间的信息传送操作称为`输入输出操作`。

I/O系统的基本功能包括
* 隐藏物理设备的细节
* 与设备的无关
* 提高处理机和I/O设备的利用率
* 对I/O设备进行控制
* 确保对设备的正确共享
* 错误处理

I/O系统的层次结构如下

|层次 | 作用|
|-----|----|
|用户层软件|产生I/O请求、格式化I/O、Spooling|
|设备独立性软件|映射、保护、分块、缓冲、分配|
|设备驱动程序|设置设备寄存器、检查状态|
|中断处理程序||
|硬件|执行I/O操作|

# I/O设备和设备控制器

## I/O设备的分类
* 按从属关系 : 系统设备、用户设备
* 按传输速率 : 低速设备、中速设备、高速设备
* 按使用特性 : 存储设备、I/O设备
* 按设备共享属性 ：独占设备、共享设备、虚拟设备
* 按信息交换单位分类 ： 字符设备、块设备

## 设备管理的任务
* 选择和分配输入输出设备以进行数据传输操作
* 控制输入输出设备和CPU或内存之间交换数据
* 将用户和设备特性分离
* 提高设备和设备之间、CPU和设备之间、进程和进程之间的并行操作度

## I/O系统的结构
不同的计算机系统的I/O系统之间差别很大，但大都采用基于总线的I/O结构

## 设备控制器
I/O设备一般由机械和电子两部分组成，设计时往往将二者分离，其中电子部分称为`设备控制器`。

设备控制器具有以下功能
* 实现主机和设备之间的通信控制，进行端口地址译码
* 数字信号和模拟信号的互相转换
* 实现数据的缓冲
* 接收主机发送的控制命令
* 将设备和控制器当前所处的状态提供给主机

CPU与控制寄存器的通信方式主要有两种
* I/O独立编址
* 存储映像/统一编址

# 通道
`通道`是一个独立于CPU的专管输入输出控制的处理机，它控制设备与内存直接进行数据交换。通道有
自己的通道指令。`通道指令`一般包含有被交换数据在内存中应占据的位置、传送方向、数据块长度
以及被控制的I/O设备的地址信息、特征信息等。

## 三种类型的通道
按照信息交换方式不同，一个系统可设立三种类型的通道
* 字节多路通道
  * 以 **字节** 为单位传送数据，主要连接大量的低速设备(终端、打印机等)
* 数组选择通道
  * 以 **块** 为单位传送数据，但一次只能执行一个通道指令程序，主要连接高速外部设备(磁盘机等)
* 数组多路通道
  * 以 **块** 为单位传送数据，主要连接中速设备(磁带机等)

# 设备驱动程序
## 对I/O设备的控制方式

### 使用轮询的可编程I/O方式
由用户进程来直接控制内存或CPU和外围设备之间的信息传送。

### 使用中断的可编程I/O方式
由I/O控制器发出中断

### DMA方式
在外设和主存之间开辟直接的数据交换通路

DMA控制方式的工作如下:
* 将待读取数据的内存始址传入MAR，将待读取数据的长度传入DC
* 启动DMA传送命令开始传送数据
* 挪用存储器周期传送数据，存储器地址减1，数据计数寄存器减1
* 判断DC的值，若DC大于0表明数据未传送完毕，返回第二步继续传送数据，直至DC为0(即数据传送完毕)
* 数据传送完毕后请求中断

### 通道控制方式
通道控制方式以内存为中心，实现设备和内存直接交换数据，一个通道可以控制多台设备与内存进行数据交换

# I/O软件

## 设备独立性
* 概念
  * 应用程序独立于具体使用的物理设备
* 实现
  * 逻辑设备和物理设备
  * 逻辑设备名到物理设备名的映射


## 设备分配
* `系统设备表SDT`记录系统中的所有设备
* `设备控制块SDB`记录设备的特性、使用的状态等
* `控制器控制块`COCB`记录控制器的特性和状态
* `通道控制表CHCT`记录`通道控制块CHCB`
* 设备分配算法
  * 先请求先服务算法
  * 优先级高者优先服务
## 设备分类
`独享设备`是指这类设备被分配后直至作业释放该设备时，其他设备才能使用这类设备

`共享设备`是指允多个用户共同使用的设备

`虚拟设备`是指代替独享设备的那部分存储空间及有关的控制结构

## SPOOLing技术
在联机情况下实现的同时外围操作称为`SPOOLing`

SPOOLing组成
* 输入和输出井
* 输入和输出缓冲区
* 输入进程和输出进程

以打印机为例说明SPOOLing的使用

SPOOLing主要有以下三个部分
* 磁盘缓冲区
* 打印缓冲区
* 管理进程和打印进程

当用户进程发出打印输出请求时，管理进程完成两项工作
* 在磁盘缓冲区申请空闲盘块，将要打印的数据送入其中暂存
* 为用户申请一张空白的用户请求打印表，将用户的打印要求送入其中，再将该表挂到文件队列上

真正的打印输出是由打印进程完成的
* 打印机空闲时打印进程取出文件队列的队首的请求打印表，将打印数据送到内存缓冲区交付打印机打印
* 打印完成后打印进程查看文件队列是否为空，若非空重复上一步；当队列为空时打印进程阻塞自己直到
再次有打印请求

SPOOLing技术的特点
* 提高I/O速度
* 将独占设备改造为共享设备
* 实现了虚拟设备功能

# 缓冲区管理

## 缓冲技术的基本实现思想
在CPU和外设之间设立缓冲区，用以暂存CPU与外设之间交换的数据，从而缓和CPU与外设速度不匹配产生的矛盾

引入缓冲的目的
* 改变CPU与IO设备间速度不匹配的矛盾
* 减少对CPU的中断频率
* 提高CPU和IO设备之间的并行性

## 缓冲技术的分类
`单缓冲`是操作系统提供的最简单的一种缓冲形式

解决两台外设、打印机和终端之间的并行操作问题的方法是设置`双缓冲`

`循环缓冲技术`是在主存中分配一组大小相等的存储区作为缓冲区，并将缓冲区链接起来，形成环形缓冲区

### 缓冲池
将系统内的所有缓冲区统一管理，形成能够用于输入、输出的`缓冲池`

缓冲池的组成
* 三个队列 : 空缓冲队列、装满输入数据队列、装满输出数据队列
* 四个缓冲区 : 收容输入、提取输入、收容输出、提取输出

缓冲池的工作方式

输入和输出过程

# 磁盘存储器的性能和调度
`磁盘`是一种随机存储设备，每个物理记录拥有确定的位置和唯一的地址。

磁盘包括多个`盘面`来存储数据，每个盘面有一个`读写磁头`，在一个盘面上的读写磁头的轨道称为`磁道`，在磁头位置下的所有磁道组成的圆柱体称为`柱面`，一个磁面可以划分为多个物理块，称为`扇区`

## 磁盘调度算法
* 先来先服务FCFS
  * 按请求到达的先后顺序服务
* 最短寻道时间优先SSTF
  * 选择与当前磁头位置最近的请求作为下一个服务对象
* SCAN
  * 磁头先处理从磁盘一端到另一端的所有请求，再转而处理反向的所有请求
* CSCAN
  * 将磁头从一端运行到另一端，当到达另一端后立刻返回原先的一端
